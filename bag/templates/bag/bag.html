{% extends "base.html" %}

{% load static %}

{% block extra_title %}

    | Shopping Bag
{% endblock extra_title %}

{% block page_header %}

    <div class="container header-container">
        <div class="row">
            <div class="col"></div>
        </div>
    </div>
{% endblock page_header %}

{% block content %}

    <div class="overlay"></div>

    <div class="container mb-5">
        <div class="row">
            <div class="col">
                <hr />
                <h1 class="logo-font mb-4">Shopping Bag</h1>
                <hr />
            </div>
        </div>

        <div class="row">
            <div class="col">
                {% if bag_items %}
                    <div class="table-responsive rounded">
                        <table class="table align-middle table-sm">
                            <thead class="text-black">
                                <tr>
                                    <th scope="col">Product</th>
                                    <th scope="col" class="d-none d-md-table-cell">Info</th>
                                    <th scope="col">Price</th>
                                    <th scope="col">Qty</th>
                                    <th scope="col">Subtotal</th>
                                </tr>
                            </thead>

                            <tbody>
                                {% for item in bag_items %}
                                    <tr>
                                        <td class="py-3">
                                            {% with img_url=item.product.display_image_url|default_if_none:'' %}
                                                {% if img_url %}
                                                    <img class="img-fluid rounded bag-product-image"
                                                         src="{{ img_url }}"
                                                         alt="{{ item.product.name }}"
                                                         width="120"
                                                         height="120"
                                                         loading="lazy"
                                                         decoding="async" />
                                                {% else %}
                                                    <img class="img-fluid rounded bag-product-image"
                                                         src="{% static 'images/noimage.png' %}"
                                                         alt="{{ item.product.name }}"
                                                         width="120"
                                                         height="120"
                                                         loading="lazy"
                                                         decoding="async" />
                                                {% endif %}
                                            {% endwith %}
                                        </td>

                                        <td class="py-3 d-none d-md-table-cell">
                                            <p class="my-0 fw-semibold">{{ item.product.name }}</p>

                                            <p class="my-0 small text-muted">
                                                <strong>Size:</strong>
                                                {% if item.product.has_sizes %}
                                                    {{ item.size|upper }}
                                                {% else %}
                                                    N/A
                                                {% endif %}
                                            </p>

                                            {% if item.product.sku %}<p class="my-0 small text-muted">SKU: {{ item.product.sku|upper }}</p>{% endif %}
                                        </td>

                                        <td class="py-3">
                                            <p class="my-0">{{ item.product.price|floatformat:2 }} €</p>
                                        </td>

                                        <td class="py-3">
                                            <form class="update-form"
                                                  method="POST"
                                                  action="{% url 'update_bag' item.item_id %}">
                                                {% csrf_token %}

                                                <div class="input-group qty-input-group">
                                                    <button type="button"
                                                            class="btn btn-black btn-sm decrement-qty"
                                                            data-item_id="{{ item.item_id }}"
                                                            aria-label="Decrease quantity">
                                                        <i class="fas fa-minus fa-sm" aria-hidden="true"></i>
                                                    </button>

                                                    <input class="form-control form-control-sm qty_input text-center"
                                                           type="number"
                                                           name="quantity"
                                                           value="{{ item.quantity }}"
                                                           min="1"
                                                           max="99"
                                                           data-item_id="{{ item.item_id }}"
                                                           id="id_qty_{{ item.item_id }}" />

                                                    <button type="button"
                                                            class="btn btn-black btn-sm increment-qty"
                                                            data-item_id="{{ item.item_id }}"
                                                            aria-label="Increase quantity">
                                                        <i class="fas fa-plus fa-sm" aria-hidden="true"></i>
                                                    </button>

                                                    {% if item.product.has_sizes %}<input type="hidden" name="product_size" value="{{ item.size }}" />{% endif %}
                                                </div>

                                                <div class="mt-2 d-flex gap-2">
                                                    <button type="submit"
                                                            class="btn btn-link p-0 text-info text-decoration-none update-link">
                                                        <small>Update</small>
                                                    </button>

                                                    <button type="button"
                                                            class="btn btn-link p-0 text-danger text-decoration-none remove-item"
                                                            data-item_id="{{ item.item_id }}"
                                                            data-size="{% if item.product.has_sizes %}{{ item.size }}{% else %}{% endif %}">
                                                        <small>Remove</small>
                                                    </button>
                                                </div>
                                            </form>

                                            <div class="d-md-none mt-3">
                                                <p class="mb-1 fw-semibold">{{ item.product.name }}</p>

                                                <p class="mb-1 small text-muted">
                                                    <strong>Size:</strong>
                                                    {% if item.product.has_sizes %}
                                                        {{ item.size|upper }}
                                                    {% else %}
                                                        N/A
                                                    {% endif %}
                                                </p>

                                                {% if item.product.sku %}<p class="mb-0 small text-muted">SKU: {{ item.product.sku|upper }}</p>{% endif %}
                                            </div>
                                        </td>

                                        <td class="py-3">
                                            <p class="my-0">{{ item.subtotal|floatformat:2 }} €</p>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <div class="row mt-4">
                        <div class="col-12 col-lg-6 ms-lg-auto">
                            <div class="border rounded-0 p-3 bg-white">
                                <h2 class="h5 mb-3">Order Summary</h2>

                                <div class="d-flex justify-content-between">
                                    <span class="text-muted">Bag Total</span>
                                    <span class="fw-semibold">{{ total|floatformat:2 }} €</span>
                                </div>

                                <div class="d-flex justify-content-between">
                                    <span class="text-muted">Delivery</span>
                                    <span class="fw-semibold">{{ delivery|floatformat:2 }} €</span>
                                </div>

                                <hr class="my-3" />

                                <div class="d-flex justify-content-between">
                                    <span class="fw-bold">Grand Total</span>
                                    <span class="fw-bold">{{ grand_total|floatformat:2 }} €</span>
                                </div>

                                {% if free_delivery_delta and free_delivery_delta > 0 %}
                                    <p class="mt-3 mb-0 text-danger small">
                                        You could get free delivery by spending just
                                        <strong>{{ free_delivery_delta|floatformat:2 }} €</strong> more!
                                    </p>
                                {% endif %}
                            </div>

                            <div class="d-flex gap-2 flex-wrap justify-content-end mt-3">
                                <a href="{% url 'products' %}" class="btn btn-outline-dark rounded-0">
                                    <i class="fas fa-chevron-left me-1" aria-hidden="true"></i>
                                    Keep Shopping
                                </a>

                                <a href="" class="btn btn-dark rounded-0 text-uppercase">
                                    Secure Checkout
                                    <i class="fas fa-lock ms-1" aria-hidden="true"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <p class="lead mb-4">Your bag is empty.</p>

                    <a href="{% url 'products' %}" class="btn btn-outline-dark rounded-0">
                        <i class="fas fa-chevron-left me-1" aria-hidden="true"></i>
                        Keep Shopping
                    </a>
                {% endif %}
            </div>
        </div>
    </div>
{% endblock content %}

{% block postloadjs %}

    {{ block.super }}
    {% include 'products/includes/quantity_input_script.html' %}

    <script>
        (function() {
            "use strict";

            function getCookie(name) {
                const value = `; ${document.cookie}`;
                const parts = value.split(`; ${name}=`);
                if (parts.length === 2) return parts.pop().split(";").shift();
                return "";
            }

            async function removeItem(itemId, size) {
                const csrfToken = getCookie("csrftoken");
                const url = `/bag/remove/${itemId}/`;

                const formData = new FormData();
                if (size) formData.append("product_size", size);

                const response = await fetch(url, {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": csrfToken,
                    },
                    body: formData,
                });

                if (!response.ok) {
                    throw new Error("Remove request failed");
                }

                window.location.reload();
            }

            document.addEventListener("click", async (event) => {
                const removeBtn = event.target.closest(".remove-item");
                if (!removeBtn) return;

                event.preventDefault();

                const itemId = removeBtn.getAttribute("data-item_id");
                const size = removeBtn.getAttribute("data-size") || "";

                if (!itemId) return;

                try {
                    await removeItem(itemId, size);
                } catch (error) {
                    alert("Sorry, something went wrong while removing the item.");
                }
            });
        })();
    </script>
{% endblock postloadjs %}
